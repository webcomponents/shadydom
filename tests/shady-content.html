<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <meta charset="utf-8">

  <script src="../bower_components/webcomponents-platform/webcomponents-platform.js"></script>
  <script src="../bower_components/template/template.js"></script>
  <script>
    ShadyDOM = {force: true};
    if (window.customElements) {
      customElements.forcePolyfill = true;
    }
  </script>
  <script src="../shadydom.min.js"></script>
  <script src="../bower_components/custom-elements/custom-elements.min.js"></script>
  <script>
    // Ensure customElements are updated when document is ready.
    if (customElements.polyfillWrapFlushCallback) {
      customElements.polyfillWrapFlushCallback(function(cb) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', cb);
        } else {
          cb();
        }
      });
    }
  </script>

  <script src="../bower_components/web-component-tester/browser.js"></script>
</head>
<body>

  <script>
    window.defineTestElement = function(name) {
      var template = document.querySelector('#' + name);
      // es5 compat class
      function Klass() {
        const self = (window.Reflect && Reflect.construct)
          ? Reflect.construct(HTMLElement, [], this.constructor || Klass)
          : HTMLElement.call(this);
        return self;
      }

      Klass.prototype = Object.create(HTMLElement.prototype, {
        'constructor': {
          value: Klass,
          configurable: true,
          writable: true
        }
      });

      Klass.prototype.connectedCallback = function() {
        if (!this._initialized) {
          this._initialized = true;
          this.attachShadow({mode: 'open'});
          this.shadowRoot.appendChild(document.importNode(template.content, true));
        }
      }

      customElements.define(name, Klass);
    }
  </script>

  <template id="x-dist">
    x-dist
    <div id="distWrapper"><slot id="content"></slot></div>
  </template>
  <script>
    defineTestElement('x-dist');
  </script>

  <template id="x-dist-simple">
    <slot id="content"></slot>
  </template>
  <script>
    defineTestElement('x-dist-simple');
  </script>

  <template id="x-dist-star"><slot></slot></template>
  <script>
    defineTestElement('x-dist-star');
  </script>

  <template id="x-dist-inside-deep-tree">
    x-dist-inside-deep-tree
    <div></div>
    <div>
      <div>
        <div>
          <div id="distWrapper"><slot id="content"></slot></div>
        </div>
      </div>
    </div>
    <div></div>
  </template>
  <script>
    defineTestElement('x-dist-inside-deep-tree');
  </script>

  <template id="x-no-dist"><span id="static">x-no-dist</span></template>
  <script>
    defineTestElement('x-no-dist');
  </script>

  <template id="x-compose-dist">
    <x-dist id="dist"></x-dist>
  </template>
  <script>
    defineTestElement('x-compose-dist');
  </script>

  <template id="x-compose-no-dist">
    <x-no-dist id="noDist"></x-no-dist>
  </template>
  <script>
    defineTestElement('x-compose-no-dist');
  </script>

  <template id="x-multi-dist">
    <x-dist id="dist1"><slot id="content1"></slot></x-dist>
    <x-dist id="dist2"><slot id="content2"></slot></x-dist>
  </template>
  <script>
    defineTestElement('x-multi-dist');
  </script>

  <template id="x-lazy-no-dist">
    Lazy no dist!
  </template>

  <template id="x-compose-lazy-no-dist">
    <x-lazy-no-dist id="lazy">
      <slot></slot>
    </x-lazy-no-dist>
  </template>
  <script>
    defineTestElement('x-compose-lazy-no-dist');
  </script>


<x-compose-lazy-no-dist><span>Child</span></x-compose-lazy-no-dist>


<script>

  function createPatchedDocumentFragment() {
    var frag = document.createDocumentFragment();
    return frag;
  }

  suite('appendChild & removeChild of <slot>', function() {

    test('append div to distributing element', function() {
      var dist = document.createElement('x-dist');
      document.body.appendChild(dist);
      // Distribute div
      var div = document.createElement('div');
      dist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, dist.shadowRoot.querySelector('#content'));
      // Append to distributed div
      var div2 = document.createElement('div');
      div.appendChild(div2);
      ShadyDOM.flush();
      // Remove
      dist.removeChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(dist);
    });

    test('append div to non-distributing element', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Distribute div
      var div = document.createElement('div');
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append to distributed div
      var div2 = document.createElement('div');
      div.appendChild(div2);
      ShadyDOM.flush();
      // Remove
      noDist.removeChild(div);
      ShadyDOM.flush();
      document.body.removeChild(noDist);
    });

    test('append div to shady root of distributing element', function() {
      var dist = document.createElement('x-dist');
      document.body.appendChild(dist);
      // Append div to root
      var div = document.createElement('div');
      dist.shadowRoot.appendChild(div);
      ShadyDOM.flush();
      // Append to div in root
      var div2 = document.createElement('div');
      div.appendChild(div2);
      ShadyDOM.flush();
      // Remove
      dist.shadowRoot.removeChild(div);
      ShadyDOM.flush();
      document.body.removeChild(dist);
    });

    test('append div to shady root of non-distributing element', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append div to root
      var div = document.createElement('div');
      noDist.shadowRoot.appendChild(div);
      ShadyDOM.flush();
      // Append to div in root
      var div2 = document.createElement('div');
      div.appendChild(div2);
      ShadyDOM.flush();
      // Remove
      noDist.shadowRoot.removeChild(div);
      ShadyDOM.flush();
      document.body.removeChild(noDist);
    });

    test('append div to distributing element in root', function() {
      var compose = document.createElement('x-compose-dist');
      document.body.appendChild(compose);
      // Distribute div
      var div = document.createElement('div');
      compose.shadowRoot.querySelector('#dist').appendChild(div);
      ShadyDOM.flush();
      // Append to distributed div
      var div2 = document.createElement('div');
      div.appendChild(div2);
      ShadyDOM.flush();
      // Remove
      compose.shadowRoot.querySelector('#dist').removeChild(div);
      ShadyDOM.flush();
      document.body.removeChild(compose);
    });

    test('append div to non-distributing element in root', function() {
      var compose = document.createElement('x-compose-no-dist');
      document.body.appendChild(compose);
      // Append div to root
      var div = document.createElement('div');
      compose.shadowRoot.querySelector('#noDist').appendChild(div);
      ShadyDOM.flush();
      // Append to div in root
      var div2 = document.createElement('div');
      div.appendChild(div2);
      ShadyDOM.flush();
      // Remove
      compose.shadowRoot.querySelector('#noDist').removeChild(div);
      ShadyDOM.flush();
      document.body.removeChild(compose);
    });

    test('append slot to shady root of element (div first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      // Append slot to shady root
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      noDist.shadowRoot.appendChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append slot to shady root of element (slot first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append slot to shady root
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      noDist.shadowRoot.appendChild(slot);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append slot to div in shady root of element (div first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to shady root
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      noDist.shadowRoot.querySelector('#static').appendChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.querySelector('#static').removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append slot to div in shady root of element (slot first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append slot to shady root
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      noDist.shadowRoot.querySelector('#static').appendChild(slot);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.querySelector('#static').removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append slot in fragment to shady root of element (div first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      frag.appendChild(slot);
      noDist.shadowRoot.appendChild(frag);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append slot in fragment to shady root of element (slot first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      frag.appendChild(slot);
      noDist.shadowRoot.appendChild(frag);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append wrapped slot to shady root of element (div first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      noDist.shadowRoot.appendChild(frag);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append wrapped slot to shady root of element (slot first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      noDist.shadowRoot.appendChild(frag);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append wrapped slot to div in shady root of element (div first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      noDist.shadowRoot.querySelector('#static').appendChild(frag);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.querySelector('#static').removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append wrapped slot to div in shady root of element (slot first)', function() {
      var noDist = document.createElement('x-no-dist');
      document.body.appendChild(noDist);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      noDist.shadowRoot.querySelector('#static').appendChild(frag);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      noDist.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      noDist.shadowRoot.querySelector('#static').removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(noDist);
    });

    test('append slot to non-distributing element in shady root of composed element (div first)', function() {
      var compose = document.createElement('x-compose-no-dist');
      document.body.appendChild(compose);
      // Append slot to light DOM of non-distributing element
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to non-distributing element
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      compose.shadowRoot.querySelector('#noDist').appendChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#noDist').removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append slot to non-distributing element in shady root of composed element (slot first)', function() {
      var compose = document.createElement('x-compose-no-dist');
      document.body.appendChild(compose);
      // Append slot to light DOM of non-distributing element
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      compose.shadowRoot.querySelector('#noDist').appendChild(slot);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#noDist').removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append wrapped slot to non-distributing element in shady root of composed element (div first)', function() {
      var compose = document.createElement('x-compose-no-dist');
      document.body.appendChild(compose);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      compose.shadowRoot.querySelector('#noDist').appendChild(frag);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#noDist').removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append wrapped slot to non-distributing element in shady root of composed element (slot first)', function() {
      var compose = document.createElement('x-compose-no-dist');
      document.body.appendChild(compose);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      compose.shadowRoot.querySelector('#noDist').appendChild(frag);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#noDist').removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append slot to distributing element in shady root of composed element (div first)', function() {
      var compose = document.createElement('x-compose-dist');
      document.body.appendChild(compose);
      // Append slot to light DOM of non-distributing element
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to non-distributing element
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      compose.shadowRoot.querySelector('#dist').appendChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#dist').removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append slot to distributing element in shady root of composed element (slot first)', function() {
      var compose = document.createElement('x-compose-dist');
      document.body.appendChild(compose);
      // Append slot to non-distributing element
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      compose.shadowRoot.querySelector('#dist').appendChild(slot);
      // Append slot to light DOM of non-distributing element
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#dist').removeChild(slot);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append wrapped slot to distributing element in shady root of composed element (div first)', function() {
      var compose = document.createElement('x-compose-dist');
      document.body.appendChild(compose);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      compose.shadowRoot.querySelector('#dist').appendChild(frag);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#dist').removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append wrapped slot to distributing element in shady root of composed element (slot first)', function() {
      var compose = document.createElement('x-compose-dist');
      document.body.appendChild(compose);
      // Append slot to shady root
      var frag = document.createDocumentFragment();
      var wrapper = document.createElement('div');
      var slot = document.createElement('slot');
      slot.setAttribute('name', 'insert');
      wrapper.appendChild(slot);
      frag.appendChild(wrapper);
      compose.shadowRoot.querySelector('#dist').appendChild(frag);
      // Append div to light dom
      var div = document.createElement('div');
      div.slot = 'insert';
      compose.appendChild(div);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, slot);
      // Remove
      compose.shadowRoot.querySelector('#dist').removeChild(wrapper);
      ShadyDOM.flush();
      assert.equal(div.assignedSlot, null);
      document.body.removeChild(compose);
    });

    test('append slot to initially un-upgraded element', function() {
      var lazyContainer = document.querySelector('x-compose-lazy-no-dist');
      var child = lazyContainer.firstElementChild;
      defineTestElement('x-lazy-no-dist');
      var slot = document.createElement('slot');
      lazyContainer.shadowRoot.querySelector('#lazy').shadowRoot.appendChild(slot);
      ShadyDOM.flush();
      assert.equal(slot.assignedNodes({flatten: true})[1], child);

    });

    test('composed children distributed', function() {
      var host = document.createElement('x-dist');
      document.body.appendChild(host);
      var target = host.shadowRoot.querySelector('#distWrapper');
      var s0 = document.createElement('span');
      var frag = document.createDocumentFragment();
      var s1 = document.createElement('span');
      var s2 = document.createElement('span');
      var s3 = document.createElement('span');
      frag.appendChild(s1);
      frag.appendChild(s2);
      frag.appendChild(s3);
      host.appendChild(s0);
      host.insertBefore(frag, s0);
      ShadyDOM.flush();
      var c$ = Array.from(getComposedChildNodes(target));
      assert.deepEqual(c$, [s1, s2, s3, s0]);
      host.removeChild(s1);
      host.removeChild(s2);
      host.removeChild(s3);
      ShadyDOM.flush();
      c$ = Array.from(getComposedChildNodes(target));
      assert.deepEqual(c$, [s0]);

    });

    test('moving children between distributing hosts', function() {
      var h1 = document.createElement('x-dist');
      var h2 = document.createElement('x-dist');
      document.body.appendChild(h1);
      document.body.appendChild(h2);
      ShadyDOM.flush();
      var d = document.createElement('div');
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
      document.body.removeChild(h2);
    });

    test('moving children between distributing hosts (parsed child)', function() {
      var div = document.createElement('div');
      div.innerHTML = '<x-dist><div></div></x-dist>';
      var h1 = div.firstChild;
      var h2 = document.createElement('x-dist');
      document.body.appendChild(div);
      document.body.appendChild(h2);
      ShadyDOM.flush();
      var d = h1.firstElementChild;
      assert.equal(d.localName, 'div');
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(div);
      document.body.removeChild(h2);
    });

    test('moving children between distributing host and fragment', function() {
      var h1 = document.createElement('x-dist');
      var h2 = createPatchedDocumentFragment();
      document.body.appendChild(h1);
      ShadyDOM.flush();
      var d = document.createElement('div');
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
    });

    test('moving children between distributing host and fragment (parsed child)', function() {
      var div = document.createElement('div');
      div.innerHTML = '<x-dist><div></div></x-dist>';
      var h1 = div.firstChild;
      var h2 = createPatchedDocumentFragment();;
      document.body.appendChild(h1);
      ShadyDOM.flush();
      var d = h1.firstElementChild;
      assert.equal(d.localName, 'div');
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
    });

    test('moving children between distributing hosts with deep insertion points', function() {
      var h1 = document.createElement('x-dist-inside-deep-tree');
      var h2 = document.createElement('x-dist-inside-deep-tree');
      document.body.appendChild(h1);
      document.body.appendChild(h2);
      ShadyDOM.flush();
      var d = document.createElement('div');
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
      document.body.removeChild(h2);
    });

    test('moving children between distributing hosts with deep insertion points (parsed child)', function() {
      var div = document.createElement('div');
      div.innerHTML = '<x-dist-inside-deep-tree><div></div></x-dist-inside-deep-tree>';
      var h1 = div.firstChild;
      var h2 = document.createElement('x-dist-inside-deep-tree');
      document.body.appendChild(div);
      document.body.appendChild(h2);
      ShadyDOM.flush();
      var d = h1.firstElementChild;
      assert.equal(d.localName, 'div');
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstElementChild, d);
      assert.deepEqual(h2.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(div);
      document.body.removeChild(h2);
    });

    test('moving children between distributing host with deep insertion and fragment', function() {
      var h1 = document.createElement('x-dist-inside-deep-tree');
      var h2 = createPatchedDocumentFragment();
      document.body.appendChild(h1);
      ShadyDOM.flush();
      var d = document.createElement('div');
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
    });

    test('moving children between distributing host with deep insertion and fragment (parsed child)', function() {
      var div = document.createElement('div');
      div.innerHTML = '<x-dist-inside-deep-tree><div></div></x-dist-inside-deep-tree>';
      var h1 = div.firstChild;
      var h2 = createPatchedDocumentFragment();
      document.body.appendChild(h1);
      ShadyDOM.flush();
      var d = h1.firstElementChild;
      assert.equal(d.localName, 'div');
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
    });

    test('moving children between distributing host with shallow insertion and fragment', function() {
      var h1 = document.createElement('x-dist-simple');
      var h2 = createPatchedDocumentFragment();
      document.body.appendChild(h1);
      ShadyDOM.flush();
      var d = document.createElement('div');
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
    });

    test('moving children between distributing host with shallow insertion and fragment (parsed child)', function() {
      var div = document.createElement('div');
      div.innerHTML = '<x-dist-simple><div></div></x-dist-simple>';
      var h1 = div.firstChild;
      var h2 = createPatchedDocumentFragment();
      document.body.appendChild(h1);
      ShadyDOM.flush();
      var d = h1.firstElementChild;
      assert.equal(d.localName, 'div');
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      h1.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h1.childNodes.length, 1);
      assert.equal(h1.firstElementChild, d);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}), [d]);
      assert.equal(h2.childNodes.length, 0);
      h2.appendChild(d);
      ShadyDOM.flush();
      assert.equal(h2.childNodes.length, 1);
      assert.equal(h2.firstChild, d);
      assert.equal(h1.childNodes.length, 0);
      assert.deepEqual(h1.shadowRoot.querySelector('#content').assignedNodes({flatten: true}).length, 0);
      document.body.removeChild(h1);
    });

    test('adding a document fragment clears nodes in the fragment', function() {
      var x = document.createElement('x-dist-star');
      document.body.appendChild(x);
      var frag = document.createDocumentFragment();
      var t = document.createTextNode('hi');
      var d = document.createElement('div');
      frag.appendChild(t);
      frag.appendChild(d);
      x.appendChild(frag);
      ShadyDOM.flush();
      assert.equal(t.parentNode, x, 'logical parent wrong');
      assert.equal(d.parentNode, x, 'logical parent wrong');
      assert.equal(frag.childNodes.length, 0, 'fragment not empty');
      document.body.removeChild(x);
    });

    test('adding a non-distributing node removes the node from its current location', function() {
      var x = document.createElement('x-dist-star');
      var t = document.createTextNode('hi');
      document.body.appendChild(t);
      x.appendChild(t);
      ShadyDOM.flush();
      assert.equal(t.parentNode, x);

    });

  });

  function getComposedChildNodes(node) {
    return ShadyDOM.nativeTree.childNodes(node);
  }

</script>

</body>
</html>
